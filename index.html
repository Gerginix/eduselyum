<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YKS / LGS Puan ve Sıralama Simülatörü</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    h1{font-size:22px;margin:0 0 6px}
    .sub{opacity:.75;margin:0 0 14px;font-size:13px;line-height:1.35}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:14px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.03);margin:12px 0}
    .switch{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .switch button{padding:10px 14px;border-radius:12px;border:1px solid #222;background:#fff;cursor:pointer;font-weight:700}
    .switch button.active{background:#111;color:#fff}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    label{font-size:12px;opacity:.8;display:block;margin:0 0 4px}
    input,select{width:100%;box-sizing:border-box;padding:10px 10px;border:1px solid #cfcfcf;border-radius:10px;font-size:14px;background:#fff}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-weight:800;cursor:pointer}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .out{white-space:pre-wrap;font-weight:700}
    .muted{opacity:.7;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{font-size:12px;opacity:.75}
    .lgsRow{display:grid;grid-template-columns:1.4fr 1fr 1fr 1fr;gap:8px;align-items:center;margin:6px 0}
    .lgsHdr{display:grid;grid-template-columns:1.4fr 1fr 1fr 1fr;gap:8px;opacity:.75;font-size:12px}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;opacity:.85}
    .err{color:#b00020;font-weight:700}
    .ok{color:#0a7a2f;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>YKS 2025 Puan & Sıralama + LGS 2025 Puan & Yüzdelik</h1>
    <p class="sub">
      YKS tarafı: deneme netleri + OBP ile puan ve sıralama. LGS tarafı: ders bazlı doğru/yanlış/net ile puan ve yüzdelik.
    </p>

    <div class="card">
      <div class="switch" id="examSwitch">
        <button type="button" id="btnYks" class="active">YKS</button>
        <button type="button" id="btnLgs">LGS</button>
      </div>

      <!-- ====================== YKS PANEL ====================== -->
      <section id="yksPanel">
        <div class="grid2">
          <div>
            <label>Puan Türü</label>
            <select id="puanTuru">
              <option value="SAY">SAY</option>
              <option value="EA">EA</option>
              <option value="SOZ">SÖZ</option>
              <option value="DIL">DİL</option>
            </select>
          </div>
          <div>
            <label>OBP (0–100)</label>
            <input id="obp" type="number" inputmode="decimal" step="0.01" min="0" max="100" data-max="100" placeholder="0">
          </div>
        </div>

        <div class="card" style="margin:12px 0 0">
          <div class="pill">TYT</div>
          <div class="grid">
            <div><label>TYT Türkçe (max 40)</label><input id="tyt_tr" type="number" step="0.01" min="0" max="40" data-max="40" placeholder="0"></div>
            <div><label>TYT Sosyal (max 20)</label><input id="tyt_sos" type="number" step="0.01" min="0" max="20" data-max="20" placeholder="0"></div>
            <div><label>TYT Matematik (max 40)</label><input id="tyt_mat" type="number" step="0.01" min="0" max="40" data-max="40" placeholder="0"></div>
            <div><label>TYT Fen (max 20)</label><input id="tyt_fen" type="number" step="0.01" min="0" max="20" data-max="20" placeholder="0"></div>
          </div>
          <p class="muted" style="margin:10px 0 0">Netler max soru sayısını aşamaz (aşarsa otomatik max’a çekilir).</p>
        </div>

        <div class="card" id="grp_say" style="margin:12px 0 0">
          <div class="pill">AYT (SAY)</div>
          <div class="grid">
            <div><label>AYT Matematik (max 40)</label><input id="ayt_mat" type="number" step="0.01" min="0" max="40" data-max="40" placeholder="0"></div>
            <div><label>AYT Fizik (max 14)</label><input id="ayt_fiz" type="number" step="0.01" min="0" max="14" data-max="14" placeholder="0"></div>
            <div><label>AYT Kimya (max 13)</label><input id="ayt_kim" type="number" step="0.01" min="0" max="13" data-max="13" placeholder="0"></div>
            <div><label>AYT Biyoloji (max 13)</label><input id="ayt_bio" type="number" step="0.01" min="0" max="13" data-max="13" placeholder="0"></div>
          </div>
        </div>

        <div class="card" id="grp_ea" style="margin:12px 0 0; display:none">
          <div class="pill">AYT (EA)</div>
          <div class="grid">
            <div><label>AYT Matematik (max 40)</label><input id="ayt_mat_ea" type="number" step="0.01" min="0" max="40" data-max="40" placeholder="0"></div>
            <div><label>AYT Edebiyat (max 24)</label><input id="ayt_edeb" type="number" step="0.01" min="0" max="24" data-max="24" placeholder="0"></div>
            <div><label>AYT Tarih-1 (max 10)</label><input id="ayt_tar1" type="number" step="0.01" min="0" max="10" data-max="10" placeholder="0"></div>
            <div><label>AYT Coğrafya-1 (max 6)</label><input id="ayt_cog1" type="number" step="0.01" min="0" max="6" data-max="6" placeholder="0"></div>
          </div>
        </div>

        <div class="card" id="grp_soz" style="margin:12px 0 0; display:none">
          <div class="pill">AYT (SÖZ)</div>
          <div class="grid">
            <div><label>AYT Edebiyat (max 24)</label><input id="ayt_edeb_soz" type="number" step="0.01" min="0" max="24" data-max="24" placeholder="0"></div>
            <div><label>AYT Tarih-1 (max 10)</label><input id="ayt_tar1_soz" type="number" step="0.01" min="0" max="10" data-max="10" placeholder="0"></div>
            <div><label>AYT Coğrafya-1 (max 6)</label><input id="ayt_cog1_soz" type="number" step="0.01" min="0" max="6" data-max="6" placeholder="0"></div>
            <div><label>AYT Tarih-2 (max 11)</label><input id="ayt_tar2" type="number" step="0.01" min="0" max="11" data-max="11" placeholder="0"></div>
            <div><label>AYT Coğrafya-2 (max 11)</label><input id="ayt_cog2" type="number" step="0.01" min="0" max="11" data-max="11" placeholder="0"></div>
            <div><label>AYT Felsefe (max 12)</label><input id="ayt_fels" type="number" step="0.01" min="0" max="12" data-max="12" placeholder="0"></div>
            <div><label>AYT DKAB (max 6)</label><input id="ayt_dkab" type="number" step="0.01" min="0" max="6" data-max="6" placeholder="0"></div>
          </div>
        </div>

        <div class="card" id="grp_dil" style="margin:12px 0 0; display:none">
          <div class="pill">YDT (DİL)</div>
          <div class="grid2">
            <div><label>YDT Net (max 80)</label><input id="ydt" type="number" step="0.01" min="0" max="80" data-max="80" placeholder="0"></div>
            <div></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="hesaplaBtn" type="button">HESAPLA</button>
          <div class="out" id="sonuc">—</div>
          <div class="out" id="sira">—</div>
        </div>
      </section>

      <!-- ====================== LGS PANEL ====================== -->
      <section id="lgsPanel" style="display:none">
        <h3 style="margin:0 0 8px">LGS 2025 Puan & Yüzdelik</h3>
        <p class="muted" style="margin:0 0 10px">
          Doğru/Yanlış tam sayıdır. Net istersen küsuratlı girilebilir. Doğru/Yanlış doluysa net otomatik hesaplanır.
        </p>

        <div class="lgsHdr">
          <div>TEST</div><div>DOĞRU</div><div>YANLIŞ</div><div>NET</div>
        </div>
        <div id="lgsRows"></div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>TOPLAM DOĞRU</label>
            <input id="lgsDogruTop" type="text" readonly>
          </div>
          <div>
            <label>TOPLAM YANLIŞ</label>
            <input id="lgsYanlisTop" type="text" readonly>
          </div>
          <div>
            <label>TOPLAM NET</label>
            <input id="lgsNetTop" type="text" readonly>
          </div>
          <div>
            <label>LGS PUANI</label>
            <input id="lgsPuan" type="text" readonly>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>GENEL YÜZDELİK DİLİMİ</label>
            <input id="lgsYuzdelik" type="text" readonly>
          </div>
          <div>
            <label>İL SEÇİMİ</label>
            <select id="lgsIl"><option value="">Yükleniyor…</option></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnLgsHesapla" type="button">HESAPLA</button>
          <div id="lgsNote" class="muted"></div>
        </div>

        <div id="lgsLists" style="display:none; margin-top:14px">
          <h4 style="margin:0 0 8px">Birinci Yerleştirme Dönemi</h4>
          <table id="tblBirinci">
            <thead><tr><th>OKUL</th><th>TABAN PUAN</th><th>YÜZDELİK</th><th>TALEP</th></tr></thead>
            <tbody></tbody>
          </table>

          <h4 style="margin:14px 0 8px">Son Nakil Dönemi</h4>
          <table id="tblNakil">
            <thead><tr><th>OKUL</th><th>TABAN PUAN</th><th>YÜZDELİK</th><th>TALEP</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <p class="muted">Not: Eğer GitHub Pages eski dosyayı cache’liyorsa Ctrl+Shift+R yap.</p>
  </div>

  <!-- YKS motoru -->
  <script src="app.js"></script>

  <!-- Input clamp + LGS motoru (YKS'yi etkilemez) -->
  <script>
    // YKS inputlarında max soru aşılmasın (app.js'ye dokunmadan)
    (function(){
      function clampInput(el){
        const max = Number(el.getAttribute("data-max"));
        if (!Number.isFinite(max)) return;
        const raw = (el.value ?? "").toString().trim();
        if (!raw) return;
        const n = Number(raw.replace(",", "."));
        if (!Number.isFinite(n)) return;
        if (n > max) el.value = String(max);
        if (n < 0) el.value = "0";
      }
      document.addEventListener("input", (e) => {
        const el = e.target;
        if (!(el instanceof HTMLInputElement)) return;
        if (!el.hasAttribute("data-max")) return;
        // sadece YKS inputlarını clamp'la
        if (el.id && el.id.startsWith("lgs_")) return;
        clampInput(el);
      }, true);
    })();

    // Sınav switch
    (function(){
      const btnY = document.getElementById("btnYks");
      const btnL = document.getElementById("btnLgs");
      const yks = document.getElementById("yksPanel");
      const lgs = document.getElementById("lgsPanel");
      function set(mode){
        const isL = mode === "LGS";
        btnY.classList.toggle("active", !isL);
        btnL.classList.toggle("active", isL);
        yks.style.display = isL ? "none" : "";
        lgs.style.display = isL ? "" : "none";
        if (isL) window.__LGS_INIT__ && window.__LGS_INIT__();
      }
      btnY.addEventListener("click", ()=>set("YKS"));
      btnL.addEventListener("click", ()=>set("LGS"));
      set("YKS");
    })();

    // LGS motoru (index.html içinde, YKS ile bağı yok)
    (function(){
      const rowsWrap = document.getElementById("lgsRows");
      const ilSelect = document.getElementById("lgsIl");
      const btnCalc = document.getElementById("btnLgsHesapla");
      const noteEl = document.getElementById("lgsNote");
      const listsWrap = document.getElementById("lgsLists");
      const outDogru = document.getElementById("lgsDogruTop");
      const outYanlis = document.getElementById("lgsYanlisTop");
      const outNet = document.getElementById("lgsNetTop");
      const outPuan = document.getElementById("lgsPuan");
      const outYuz = document.getElementById("lgsYuzdelik");

      let DATA = null;

      const toNum = (v) => {
        if (v == null) return NaN;
        const s = String(v).trim().replace(",", ".");
        if (!s) return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      };
      const fmt2 = (n) => Number.isFinite(n) ? n.toFixed(2).replace(".", ",") : "";
      const fmtP = (n) => Number.isFinite(n) ? n.toFixed(2).replace(".", ",") : "";
      const clamp = (n, min, max) => Number.isFinite(n) ? Math.min(max, Math.max(min, n)) : NaN;

      function buildRows(){
        rowsWrap.innerHTML = "";
        const tests = Array.isArray(DATA?.testler) ? DATA.testler : [];
        const ratio = Number(DATA?.yanlis_dogru_orani ?? 3);

        tests.forEach((t, i) => {
          const name = t.test ?? t.ad ?? ("TEST " + (i+1));
          const max = Number(t.max_dogru ?? t.max ?? 0);
          const kats = Number(t.katsayi ?? 0);

          const row = document.createElement("div");
          row.className = "lgsRow";
          row.dataset.max = String(max);
          row.dataset.katsayi = String(kats);
          row.innerHTML = `
            <div><strong>${name}</strong> <span class="muted">(max ${max})</span></div>
            <div><input class="d" type="number" step="1" min="0" max="${max}" placeholder="0"></div>
            <div><input class="y" type="number" step="1" min="0" max="${max}" placeholder="0"></div>
            <div><input class="n" type="number" step="0.01" min="0" max="${max}" placeholder="0"></div>
          `;

          const dEl = row.querySelector(".d");
          const yEl = row.querySelector(".y");
          const nEl = row.querySelector(".n");

          function recalc(from){
            const mx = Number(row.dataset.max||0);

            let d = toNum(dEl.value);
            let y = toNum(yEl.value);
            let n = toNum(nEl.value);

            if (from === "n" && Number.isFinite(n)) {
              // Net girildiyse D/Y temizle
              n = clamp(n, 0, mx);
              nEl.value = fmt2(n);
              dEl.value = "";
              yEl.value = "";
            } else {
              // D/Y girildiyse NET hesapla
              d = Number.isFinite(d) ? clamp(Math.floor(d), 0, mx) : NaN;
              y = Number.isFinite(y) ? clamp(Math.floor(y), 0, mx) : NaN;

              if (Number.isFinite(d)) dEl.value = String(d);
              if (Number.isFinite(y)) yEl.value = String(y);

              if (Number.isFinite(d) || Number.isFinite(y)) {
                const dd = Number.isFinite(d) ? d : 0;
                const yy = Number.isFinite(y) ? y : 0;
                if (dd + yy > mx) {
                  // basit kural: önce doğru kalsın, yanlış kırp
                  const newY = Math.max(0, mx - dd);
                  yEl.value = String(newY);
                  y = newY;
                }
                const net = clamp((Number.isFinite(d)?d:0) - (Number.isFinite(y)?y:0)/ratio, 0, mx);
                nEl.value = fmt2(net);
              } else if (Number.isFinite(n)) {
                n = clamp(n, 0, mx);
                nEl.value = fmt2(n);
              } else {
                nEl.value = "";
              }
            }
            recalcTotals();
          }

          dEl.addEventListener("input", ()=>recalc("d"));
          yEl.addEventListener("input", ()=>recalc("y"));
          nEl.addEventListener("input", ()=>recalc("n"));

          rowsWrap.appendChild(row);
        });

        recalcTotals();
      }

      function recalcTotals(){
        if (!DATA) return;
        const ratio = Number(DATA?.yanlis_dogru_orani ?? 3);

        let sumD=0, sumY=0, sumN=0;
        rowsWrap.querySelectorAll(".lgsRow").forEach(r=>{
          const mx = Number(r.dataset.max||0);
          const dEl = r.querySelector(".d");
          const yEl = r.querySelector(".y");
          const nEl = r.querySelector(".n");
          const d = toNum(dEl.value);
          const y = toNum(yEl.value);
          let n = toNum(nEl.value);

          if (Number.isFinite(d)) sumD += clamp(Math.floor(d),0,mx);
          if (Number.isFinite(y)) sumY += clamp(Math.floor(y),0,mx);

          if (!Number.isFinite(n)) {
            const dd = Number.isFinite(d)?d:0;
            const yy = Number.isFinite(y)?y:0;
            n = dd - yy/ratio;
          }
          if (Number.isFinite(n)) sumN += clamp(n,0,mx);
        });

        outDogru.value = fmt2(sumD);
        outYanlis.value = fmt2(sumY);
        outNet.value = fmt2(sumN);
      }

      function nearestIndex(arr, x){
        let bestI=0, bestD=Infinity;
        for (let i=0;i<arr.length;i++){
          const d = Math.abs(arr[i]-x);
          if (d < bestD){ bestD=d; bestI=i; }
        }
        return bestI;
      }

      function fillTable(tblId, rows, yuzKey){
        const tbl = document.getElementById(tblId);
        const tbody = tbl.querySelector("tbody");
        tbody.innerHTML = "";
        rows.forEach(o=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(o.okul||"")}</td>
            <td>${Number.isFinite(Number(o.puan_2025))?fmtP(Number(o.puan_2025)):""}</td>
            <td>${Number.isFinite(Number(o[yuzKey]))?fmt2(Number(o[yuzKey])):""}</td>
            <td>${(o.trend_2025||"")}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function calc(){
        if (!DATA) return;
        const base = Number(DATA.base_puan ?? 0);
        let puan = base;

        rowsWrap.querySelectorAll(".lgsRow").forEach(r=>{
          const mx = Number(r.dataset.max||0);
          const kats = Number(r.dataset.katsayi||0);
          const nEl = r.querySelector(".n");
          let n = toNum(nEl.value);
          if (!Number.isFinite(n)) n = 0;
          n = clamp(n,0,mx);
          puan += n*kats;
        });

        outPuan.value = fmtP(puan);

        const tab = DATA.yuzdelik_tablosu || {};
        const puanArr = Array.isArray(tab.puan) ? tab.puan.map(Number) : [];
        const yuzArr = Array.isArray(tab.yuzdelik) ? tab.yuzdelik.map(Number) : [];
        const nakilArr = Array.isArray(tab.nakil_yuzdelik) ? tab.nakil_yuzdelik.map(Number) : [];

        if (puanArr.length && yuzArr.length){
          const i = nearestIndex(puanArr, puan);
          const yuz = yuzArr[i];
          outYuz.value = fmt2(yuz);

          const il = (ilSelect.value||"").trim();
          const okullar = Array.isArray(DATA.okullar) ? DATA.okullar : [];

          const birinci = okullar
            .filter(o => (o.il||"").toString().trim()===il && Number.isFinite(Number(o.yuzdelik_2025)))
            .map(o => ({...o, diff: Math.abs(Number(o.yuzdelik_2025)-yuz)}))
            .sort((a,b)=>a.diff-b.diff)
            .slice(0,12);

          const nakil = okullar
            .filter(o => (o.il||"").toString().trim()===il && Number.isFinite(Number(o.nakil_yuzdelik_2025)))
            .map(o => ({...o, diff: Math.abs(Number(o.nakil_yuzdelik_2025)-Number(nakilArr[i]||yuz))}))
            .sort((a,b)=>a.diff-b.diff)
            .slice(0,12);

          fillTable("tblBirinci", birinci, "yuzdelik_2025");
          fillTable("tblNakil", nakil, "nakil_yuzdelik_2025");
          listsWrap.style.display = "";
          noteEl.textContent = "";
        } else {
          listsWrap.style.display = "none";
          noteEl.textContent = "lgs.json: yüzdelik_tablosu bulunamadı.";
        }
      }

      async function init(){
        try{
          noteEl.textContent = "lgs.json yükleniyor…";
          const res = await fetch("lgs.json", { cache: "no-store" });
          if (!res.ok) throw new Error("lgs.json okunamadı");
          DATA = await res.json();

          buildRows();

          const okullar = Array.isArray(DATA.okullar) ? DATA.okullar : [];
          const iller = Array.from(new Set(okullar.map(o => (o.il||"").toString().trim()).filter(Boolean)))
            .sort((a,b)=>a.localeCompare(b,"tr"));

          ilSelect.innerHTML = "";
          if (!iller.length){
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "İller bulunamadı (okullar boş?)";
            ilSelect.appendChild(opt);
            noteEl.innerHTML = '<span class="err">lgs.json içinde okullar/il alanı yok ya da boş.</span>';
          } else {
            iller.forEach(il=>{
              const opt = document.createElement("option");
              opt.value = il;
              opt.textContent = il;
              ilSelect.appendChild(opt);
            });
            if (iller.includes("İSTANBUL")) ilSelect.value = "İSTANBUL";
            noteEl.innerHTML = '<span class="ok">lgs.json yüklendi.</span>';
          }

          btnCalc.addEventListener("click", calc);
        }catch(e){
          console.error(e);
          noteEl.innerHTML = '<span class="err">lgs.json yüklenemedi. Repo kökünde lgs.json var mı?</span>';
          ilSelect.innerHTML = '<option value="">Hata</option>';
        }
      }

      window.__LGS_INIT__ = function(){ if (!DATA) init(); };

    })();
  </script>
</body>
</html>
